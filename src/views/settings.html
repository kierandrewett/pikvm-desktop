<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PiKVM Connect</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <main>
            <div id="pikvm-panel">
                <form id="pikvm-form">
                    <input
                        id="pikvm-url"
                        placeholder="PiKVM URL (e.g. http://pikvm/)"
                        autofocus
                    />
                    <button id="pikvm-save" type="submit">Connect</button>
                </form>
            </div>
        </main>
        <script async>
            const main = async () => {
                /** @type {HTMLInputElement} */
                const urlInput = document.getElementById("pikvm-url");
                const saveButton = document.getElementById("pikvm-save");
                const form = document.getElementById("pikvm-form");

                const currentOrigin = await ui.invoke("pikvm:get-origin");
                urlInput.value = currentOrigin;

                form.addEventListener("submit", (e) => {
                    e.preventDefault();
                });

                urlInput.setSelectionRange(0, urlInput.value.length, "forward");

                saveButton.addEventListener("click", () => {
                    const newOrigin = urlInput.value.trim();
                    if (!newOrigin.startsWith("http")) {
                        alert(
                            "Please enter a valid URL starting with http or https."
                        );
                        return;
                    }

                    saveButton.setAttribute("disabled", "true");
                    saveButton.textContent = "Connecting...";

                    ui.invoke("pikvm:set-origin", newOrigin).then((success) => {
                        if (success) {
                            ui.send("pikvm:connect");
                        } else {
                            alert("Failed to update origin. Please try again.");
                            saveButton.removeAttribute("disabled");
                        }
                    });
                });

                ui.onState(async (state) => {
                    document.body.setAttribute(
                        "data-theme",
                        state.theme || "light"
                    );
                    console.log("Applied theme:", state.theme);
                });
            };

            main();
        </script>
    </body>
</html>
